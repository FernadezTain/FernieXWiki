<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FernieX Wiki</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Canvas -->
  <canvas id="particle-network"></canvas>

  <!-- Баннер -->
  <div id="dev-banner">
    <div class="dev-banner-content">
      <h2>⚠️ Сайт в разработке</h2>
      <p>Некоторые функции могут быть недоступны.</p>
      <button id="close-banner">Понятно</button>
    </div>
  </div>

  <!-- Верхняя панель -->
  <header class="top-bar">
    <div class="search-bar">
      <input type="text" placeholder="Поиск..." disabled>
    </div>
    <div class="current-section">Главная</div>
  </header>

  <!-- Боковое меню -->
  <aside class="side-panel">
    <div class="side-handle">›</div>
    <nav class="side-menu">
      <div class="side-item" data-section="Игровые функции">Игровые функции</div>
      <div class="side-item" data-section="Чат-менеджер">Чат-менеджер</div>
      <div class="side-item" data-section="Команды">Команды</div>
      <div class="side-item" data-section="Статистика">Статистика</div>
      <div class="side-item" data-section="Настройки">Настройки</div>
      <div class="side-item" data-section="Дополнительно">Дополнительно</div>
    </nav>
  </aside>

  <!-- Контент -->
  <main class="main-content">
    <p class="hint">Выберите раздел слева</p>
    <div id="posts-container"></div>
  </main>

  <!-- Полоска -->
  <div class="post-bar" id="post-bar"></div>

  <!-- Модалка -->
  <div class="modal" id="post-modal">
    <div class="modal-content">
      <h2>Публикация поста</h2>

      <input type="password" id="post-password" placeholder="Пароль администратора">

      <select id="post-category">
        <option>Игровые функции</option>
        <option>Чат-менеджер</option>
        <option>Команды</option>
        <option>Статистика</option>
        <option>Настройки</option>
        <option>Дополнительно</option>
      </select>

      <input type="text" id="post-photo" placeholder="Ссылка на фото (необязательно)">
      <textarea id="post-text" placeholder="Текст поста"></textarea>

      <button id="submit-post">Опубликовать</button>
      <button id="close-modal">Отмена</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBc6Bf4oHrTyWsQp9CrrRPNyGSqm4w8J_M",
      authDomain: "ferniexwiki.firebaseapp.com",
      projectId: "ferniexwiki",
      storageBucket: "ferniexwiki.firebasestorage.app",
      messagingSenderId: "451396973595",
      appId: "1:451396973595:web:f31a19ade2b8b6c5f374be"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ADMIN_PASSWORD = "12345";

    const modal = document.getElementById("post-modal");
    const postBar = document.getElementById("post-bar");
    const closeModal = document.getElementById("close-modal");
    const submitPost = document.getElementById("submit-post");
    const postsContainer = document.getElementById("posts-container");
    const currentSection = document.querySelector(".current-section");

    // открыть/закрыть модалку
    postBar.addEventListener("click", () => modal.classList.add("active"));
    closeModal.addEventListener("click", () => modal.classList.remove("active"));

    // публикация поста
    submitPost.addEventListener("click", async () => {
      const password = document.getElementById("post-password").value;
      const category = document.getElementById("post-category").value;
      const text = document.getElementById("post-text").value.trim();
      const photo = document.getElementById("post-photo").value.trim();

      if (password !== ADMIN_PASSWORD) {
        alert("Неверный пароль");
        return;
      }
      if (!text) {
        alert("Текст пустой");
        return;
      }

      try {
        await addDoc(collection(db, "posts"), {
          category,
          text,
          photo: photo || null,
          createdAt: serverTimestamp()
        });
        modal.classList.remove("active");
        document.getElementById("post-password").value = "";
        document.getElementById("post-text").value = "";
        document.getElementById("post-photo").value = "";
        loadPosts(category);
      } catch (e) {
        alert("Ошибка публикации");
        console.error(e);
      }
    });

    // загрузка постов по категории
    async function loadPosts(category) {
      postsContainer.innerHTML = "";
      const q = query(
        collection(db, "posts"),
        where("category", "==", category),
        orderBy("createdAt", "desc")
      );
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        postsContainer.innerHTML = "<p class='hint'>Пока нет постов</p>";
        return;
      }
      snapshot.forEach(doc => {
        const post = doc.data();
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `${post.photo ? `<img src="${post.photo}">` : ""}<div class="post-text collapsed">${post.text}</div>`;
        const textEl = div.querySelector(".post-text");
        textEl.addEventListener("click", () => textEl.classList.toggle("collapsed"));
        postsContainer.appendChild(div);
      });
    }

    // навигация
    document.querySelectorAll(".side-item").forEach(item => {
      item.addEventListener("click", () => {
        const section = item.dataset.section;
        currentSection.textContent = section;
        loadPosts(section);
      });
    });
  </script>

  <!-- Баннер -->
  <script>
    document.getElementById("close-banner").onclick = () => {
      document.getElementById("dev-banner").remove();
    };
  </script>

  <script src="particles.js"></script>

</body>
</html>
